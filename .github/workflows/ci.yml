name: Basic CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  basic-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # Cache dependencies for faster installs
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run type checking (blocking)
        run: bun run typecheck

      - name: Run linting (non-blocking)
        run: bun run lint || echo "‚ö†Ô∏è Linting issues found"
        continue-on-error: true

  documentation-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation structure
        run: |
          echo "üìö Checking documentation..."
          FILES="README.md CONTRIBUTING.md LICENSE docs/README.md docs/getting-started.md docs/DEPLOYMENT.md docs/quality-standards.md"
          for file in $FILES; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå Missing: $file"
              exit 1
            fi
          done
          echo "‚úÖ All documentation files present"

  security-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for sensitive files
        run: |
          echo "üîí Security check..."
          if grep -q "\.env" .gitignore && grep -q "database.sqlite" .gitignore; then
            echo "‚úÖ Sensitive files properly ignored"
          else
            echo "‚ùå .gitignore missing sensitive file patterns"
            exit 1
          fi

  build-check:
    runs-on: ubuntu-latest
    needs: [basic-checks]
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Setup environment
        run: cp .env.ci .env.local

      - name: Cache Next.js build
        uses: actions/cache@v3
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-

      - name: Build project
        run: bun run ci:build

      - name: Verify build output
        run: |
          echo "‚úÖ Build completed successfully"
          test -d .next && echo "‚úÖ .next directory exists"
          test -f .next/BUILD_ID && echo "‚úÖ Build ID generated"
          echo "‚úÖ All checks passed"
